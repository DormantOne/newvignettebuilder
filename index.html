<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Vignette</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #input-container, #password-container, #json-container { margin-top: 20px; }
        #input-container textarea, #json-container pre, #vignette-container textarea { width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Interactive Vignette</h1>
    
    <div id="creation-container">
        <h2>Create Vignette</h2>
        <textarea id="vignetteInput" rows="10" placeholder="Enter your vignette here..."></textarea>
        <button onclick="submitVignette()">Submit Vignette</button>
    </div>
    
    <div id="password-container" class="hidden">
        <h2>Decrypt API Key</h2>
        <input type="password" id="password" placeholder="Enter password">
        <button onclick="decryptApiKey()">Decrypt API Key and Generate JSON</button>
    </div>
    
    <div id="json-container" class="hidden">
        <h2>Generated JSON</h2>
        <pre id="jsonOutput"></pre>
        <button onclick="startVignette()">Start Vignette</button>
    </div>
    
    <div id="vignette-container" class="hidden">
        <p id="vignette-text">Vignette will start here...</p>
        <div id="input-container">
            <textarea id="userInput" rows="3" placeholder="Enter your response..."></textarea>
            <button onclick="submitResponse()">Submit Response</button>
        </div>
    </div>
    
    <script>
        let vignetteJSON = {
            events: [],
            dependencies: [],
            outcomes: []
        };
        const encryptedApiKey = "U2FsdGVkX18tjJqgGvHJxbN/7ZbxOV0RKpgWlaHk8c7ajA3LMb6/I9/EcERfK68Uj44MnlHQvnMsrqi23pr7bAJLzdcQ0nXs1QVV7hxv//mNuhKsC2+vX3WQGeeh6jw3DUKFxa7CxpKunx+SoJz6fw==";
        let decryptedApiKey = null;
        
        function submitVignette() {
            const vignette = document.getElementById('vignetteInput').value;
            vignetteJSON.events.push({ event: vignette });
            document.getElementById('creation-container').classList.add('hidden');
            document.getElementById('password-container').classList.remove('hidden');
        }
        
        function decryptApiKey() {
            const password = document.getElementById('password').value;
            const key = CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex).slice(0, 32);
            const decryptedKeyBytes = CryptoJS.AES.decrypt(encryptedApiKey, key);
            decryptedApiKey = decryptedKeyBytes.toString(CryptoJS.enc.Utf8);
            
            if (decryptedApiKey) {
                generateJsonWithOpenAI(decryptedApiKey, 0);
            } else {
                alert("Incorrect password.");
            }
        }
        
        async function generateJsonWithOpenAI(apiKey, attempt, previousResponse = "") {
            const text = vignetteJSON.events[0].event;
            const prompt = attempt === 0 
                ? `Create a JSON structure for the following vignette:\n\n${text}`
                : `The previous JSON response was invalid. Here is the response:\n\n${previousResponse}\n\nError: ${attempt.error}\n\nPlease correct the JSON structure.`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": prompt}
                        ],
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const responseText = data.choices[0].message.content.trim();

                // Attempt to parse the response as JSON
                try {
                    vignetteJSON = JSON.parse(responseText);
                    document.getElementById('jsonOutput').textContent = JSON.stringify(vignetteJSON, null, 2);
                    document.getElementById('password-container').classList.add('hidden');
                    document.getElementById('json-container').classList.remove('hidden');
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    if (attempt < 3) {
                        console.log(`Retrying... Attempt ${attempt + 1}`);
                        generateJsonWithOpenAI(apiKey, attempt + 1, { response: responseText, error: e.message });
                    } else {
                        alert('The response from the AI could not be parsed as JSON after multiple attempts.');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                if (attempt < 3) {
                    console.log(`Retrying... Attempt ${attempt + 1}`);
                    generateJsonWithOpenAI(apiKey, attempt + 1, { response: previousResponse, error: error.message });
                } else {
                    alert('Failed to generate JSON after multiple attempts.');
                }
            }
        }
        
        function startVignette() {
            document.getElementById('json-container').classList.add('hidden');
            document.getElementById('vignette-container').classList.remove('hidden');
            const initialEvent = vignetteJSON.events.length > 0 ? vignetteJSON.events[0].event : "Starting the vignette...";
            document.getElementById('vignette-text').innerHTML = `<strong>AI:</strong> ${initialEvent}`;
        }
        
        function submitResponse() {
            const userInput = document.getElementById('userInput').value;
            if (userInput.trim()) {
                vignetteJSON.events.push({ event: userInput });
                updateVignetteText(`<strong>User:</strong> ${userInput}`);
                generateNextStep();
                document.getElementById('userInput').value = '';
            }
        }
        
        function updateVignetteText(text) {
            const vignetteText = document.getElementById('vignette-text');
            vignetteText.innerHTML += `<br>${text}`;
        }
        
        async function generateNextStep() {
            const prompt = `Given the following events:\n\n${vignetteJSON.events.map(e => e.event).join('\n')}\n\nWhat should be the next steps or considerations?`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${decryptedApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": prompt}
                        ],
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const responseText = data.choices[0].message.content.trim();
                updateVignetteText(`<strong>AI:</strong> ${responseText}`);
                vignetteJSON.outcomes.push(responseText);
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
