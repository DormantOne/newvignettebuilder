<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Vignette</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #input-container, #password-container, #json-container { margin-top: 20px; }
        #input-container textarea, #json-container textarea, #vignette-container textarea { width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Interactive Vignette</h1>
    
    <div id="creation-container">
        <h2>Create Vignette</h2>
        <textarea id="vignetteInput" rows="10" placeholder="Enter your vignette here..."></textarea>
        <button onclick="submitVignette()">Submit Vignette</button>
    </div>
    
    <div id="password-container" class="hidden">
        <h2>Decrypt API Key</h2>
        <input type="password" id="password" placeholder="Enter password">
        <button onclick="decryptApiKey()">Decrypt API Key and Generate JSON</button>
    </div>
    
    <div id="json-container" class="hidden">
        <h2>Edit Vignette Details</h2>
        <div id="initialVignette"></div>
        <label for="mainText">Starting Vignette:</label>
        <textarea id="mainText" rows="3"></textarea>
        <div id="ifThenContainer"></div>
        <button onclick="addIfThen()">Add IF... THEN</button>
        <button onclick="startVignette()">Start Vignette</button>
    </div>
    
    <div id="vignette-container" class="hidden">
        <p id="vignette-text">Vignette will start here...</p>
        <div id="input-container">
            <textarea id="userInput" rows="3" placeholder="Enter your response..."></textarea>
            <button onclick="submitResponse()">Submit Response</button>
            <button onclick="analysis()">Analysis</button>
        </div>
    </div>
    
    <script>
        let vignetteJSON = {
            main: "",
            ifThenStatements: [],
            conversation: []
        };
        const encryptedApiKey = "U2FsdGVkX18tjJqgGvHJxbN/7ZbxOV0RKpgWlaHk8c7ajA3LMb6/I9/EcERfK68Uj44MnlHQvnMsrqi23pr7bAJLzdcQ0nXs1QVV7hxv//mNuhKsC2+vX3WQGeeh6jw3DUKFxa7CxpKunx+SoJz6fw==";
        let decryptedApiKey = null;

        function submitVignette() {
            const vignette = document.getElementById('vignetteInput').value;
            vignetteJSON.main = vignette;
            document.getElementById('initialVignette').innerText = vignette;
            document.getElementById('creation-container').classList.add('hidden');
            document.getElementById('password-container').classList.remove('hidden');
        }
        
        function decryptApiKey() {
            const password = document.getElementById('password').value;
            const key = CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex).slice(0, 32);
            const decryptedKeyBytes = CryptoJS.AES.decrypt(encryptedApiKey, key);
            decryptedApiKey = decryptedKeyBytes.toString(CryptoJS.enc.Utf8);
            
            if (decryptedApiKey) {
                generateJsonWithOpenAI(decryptedApiKey, 0);
            } else {
                alert("Incorrect password.");
            }
        }
        
        async function generateJsonWithOpenAI(apiKey, attempt, previousResponse = "", error = "") {
            const text = vignetteJSON.main;
            const prompt = attempt === 0 
                ? `Break down the following vignette into a JSON structure with an initial starting vignette and multiple "IF... THEN" statements. Ensure the response is only valid JSON and nothing else. Use the following format: {"main": "text", "ifThenStatements": [{"if": "condition", "then": "result"}, {"if": "another condition", "then": "another result"}]}\n\nVignette:\n\n${text}`
                : `The previous JSON response was invalid. Here is the response:\n\n${previousResponse}\n\nError: ${error}\n\nPlease provide a corrected and valid JSON structure using the following format: {"main": "text", "ifThenStatements": [{"if": "condition", "then": "result"}, {"if": "another condition", "then": "another result"}]}`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": prompt}
                        ],
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const responseText = data.choices[0].message.content.trim();

                // Attempt to parse the response as JSON
                try {
                    vignetteJSON = JSON.parse(responseText);
                    document.getElementById('mainText').value = vignetteJSON.main;
                    vignetteJSON.ifThenStatements.forEach((statement, index) => {
                        addIfThen(statement.if, statement.then, index === 0);
                    });
                    document.getElementById('password-container').classList.add('hidden');
                    document.getElementById('json-container').classList.remove('hidden');
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    if (attempt < 3) {
                        console.log(`Retrying... Attempt ${attempt + 1}`);
                        generateJsonWithOpenAI(apiKey, attempt + 1, responseText, e.message);
                    } else {
                        alert('The response from the AI could not be parsed as JSON after multiple attempts.');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                if (attempt < 3) {
                    console.log(`Retrying... Attempt ${attempt + 1}`);
                    generateJsonWithOpenAI(apiKey, attempt + 1, previousResponse, error.message);
                } else {
                    alert('Failed to generate JSON after multiple attempts.');
                }
            }
        }
        
        function addIfThen(ifText = "", thenText = "", initial = false) {
            const container = document.getElementById('ifThenContainer');
            const div = document.createElement('div');
            div.className = 'if-then-box';
            div.innerHTML = `
                <label>IF:</label>
                <textarea class="if-text" rows="2">${ifText}</textarea>
                <label>THEN:</label>
                <textarea class="then-text" rows="2">${thenText}</textarea>
            `;
            container.appendChild(div);

            if (!initial) {
                vignetteJSON.ifThenStatements.push({ if: ifText, then: thenText });
            }
        }

        function startVignette() {
            // Update vignetteJSON with edited values
            vignetteJSON.main = document.getElementById('mainText').value;
            vignetteJSON.ifThenStatements = Array.from(document.getElementsByClassName('if-then-box')).map(box => ({
                if: box.getElementsByClassName('if-text')[0].value,
                then: box.getElementsByClassName('then-text')[0].value
            }));
            
            document.getElementById('json-container').classList.add('hidden');
            document.getElementById('vignette-container').classList.remove('hidden');
            const initialEvent = vignetteJSON.main ? vignetteJSON.main : "Starting the vignette...";
            document.getElementById('vignette-text').innerHTML = `<strong>AI:</strong> ${initialEvent}`;
            vignetteJSON.conversation.push({ role: 'AI', content: initialEvent });
        }
        
        function submitResponse() {
            const userInput = document.getElementById('userInput').value;
            if (userInput.trim()) {
                vignetteJSON.conversation.push({ role: 'User', content: userInput });
                updateVignetteText(`<strong>User:</strong> ${userInput}`);
                generateNextStep();
                document.getElementById('userInput').value = '';
            }
        }
        
        function updateVignetteText(text) {
            const vignetteText = document.getElementById('vignette-text');
            vignetteText.innerHTML += `<br>${text}`;
        }
        
        async function generateNextStep() {
            const conversationHistory = vignetteJSON.conversation.map(entry => `${entry.role}: ${entry.content}`).join('\n');
            const ifThenStatements = vignetteJSON.ifThenStatements.map(statement => `IF ${statement.if} THEN ${statement.then}`).join('\n');
            const prompt = `Given the following conversation and IF... THEN statements, choose the best fit and provide a response that makes sense and logically extends the vignette. Ensure the response is based on the conversation context and provide the next logical step. If there is no matching IF... THEN statement, consider a reasonable possibility.\n\nConversation:\n${conversationHistory}\n\nIF... THEN Statements:\n${ifThenStatements}`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${decryptedApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": prompt}
                        ],
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const responseText = data.choices[0].message.content.trim();
                updateVignetteText(`<strong>AI:</strong> ${responseText}`);
                vignetteJSON.conversation.push({ role: 'AI', content: responseText });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function analysis() {
            const conversationHistory = vignetteJSON.conversation.map(entry => `${entry.role}: ${entry.content}`).join('\n');
            const ifThenStatements = vignetteJSON.ifThenStatements.map(statement => `IF ${statement.if} THEN ${statement.then}`).join('\n');
            const prompt = `Provide a comprehensive review of the following vignette, conversation, and IF... THEN statements:\n\nInitial Vignette:\n${vignetteJSON.main}\n\nConversation:\n${conversationHistory}\n\nIF... THEN Statements:\n${ifThenStatements}`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${decryptedApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": prompt}
                        ],
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const responseText = data.choices[0].message.content.trim();
                updateVignetteText(`<strong>Analysis:</strong> ${responseText}`);
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
